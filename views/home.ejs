<!DOCTYPE html>
<html>
  <head>
    <title>Accueil</title>
    <link rel='stylesheet' href='/stylesheets/home.css' />
  </head>
  <body>
    <p>Welcome to <%= title %></p>
	<a href="http://localhost:3000/home/profil">Go your profil	</a>
	<div class="div_enter_data">
		<form action="/deconnexion" method="post">
		    <div class="button">
		        <button type="submit">Deconnexion</button>
		    </div>
		</form>
	</div>

	<div class="filtres">
		<h2>Filtres: </h2>
		<form id="form_filtres" method="post">
      <p>Age :
			    <input type="number" name="age_min" value="18">
          <input type="number" name="age_max" value="85">
      </p>
      <br>
      <p>Scores popularity :
          <input type="number" name="score_min" value="200">
          <input type="number" name="score_max" value="1000">
      </p>
      <br>
      <p>Interets :
          <input type="text" name="interets" placeholder="ex: #velo #fromage">
      </p>
      <br>
      <p>Adresse :
        <input id="user_input_autocomplete_address" name="adresse" placeholder="Start typing your address...">
      </p>
      <br>
        <input id="filtres_bouton" value="appliquer" type="submit">
		</form>
	</div>
	<div class="suggestions">
		<% users.forEach(function(user){ %>
		<div class="user_suggestion">
			<p>
    			<%= user.nom %> - <%= user.prenom %> - <%= user.login %>
				<br>
				Age : <%= user.age %>
			</p>
			<h3><%= user.sex %> - <%= user.orientation %></h3>
			<a href='users/<%= user.login %>'>Go profil</a>
		</div>
  		<% }); %>
	</div>
  <%if (viewers) { %>
    <p>10 last viewers !</p>
    <div class="viewer_of_my_profil">
      <% for(var i=0 ;i < 10 ;i++) { %>
        <p><%= viewers[i] %></p>
      <% } %>
    </div>
  <% } %>
  <br> <br>
  <p>Users connected</p>
	<div class="amis">
		<p>toto</p>
		<p>kneth</p>
	</div>




      <div id="users"></div>
	  <div id="allchat"></div>

<script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.2.1.min.js"></script>

  <script src="http://localhost:3003/socket.io/socket.io.js"></script>
  <script type="text/javascript"
    src="https://maps.googleapis.com/maps/api/js?libraries=places&key=AIzaSyCYV5V1wefNwQQ_5ukp4SLtcqmrUh2Kp48">
  </script>





<!-- pour add l'input avec l'autocomplete -->
  <script type="text/javascript">
  function initializeAutocomplete(id) {
var element = document.getElementById(id);
if (element) {
  var autocomplete = new google.maps.places.Autocomplete(element, { types: ['geocode'] });
  google.maps.event.addListener(autocomplete, 'place_changed', onPlaceChanged);
}
}

function onPlaceChanged() {
  var place = this.getPlace();

  // console.log(place);  // Uncomment this line to view the full object returned by Google API.

  for (var i in place.address_components) {
    var component = place.address_components[i];
    for (var j in component.types) {  // Some types are ["country", "political"]
      var type_element = document.getElementById(component.types[j]);
      if (type_element) {
        type_element.value = component.long_name;
      }
    }
  }
}

google.maps.event.addDomListener(window, 'load', function() {
  initializeAutocomplete('user_input_autocomplete_address');
});










  </script>
  <script type="text/javascript">
  $(document).ready(function(){

	  $(".friends").click(function() {
  		alert('bite');
  	 });
    $('#form_filtres').submit(function () {
      var userss = <%- JSON.stringify(users) %>
  			$.ajax({
  			  type: 'POST',
          dataType: 'json',
  			  data: JSON.stringify({
            userss: userss,
            age_min: $('#form_filtres input[name=age_min]').val(),
            age_max: $('#form_filtres input[name=age_max]').val(),
            score_min: $('#form_filtres input[name=score_min]').val(),
            score_max: $('#form_filtres input[name=score_max]').val(),
            interets: $('#form_filtres input[name=interets]').val(),
            adresse: $('#form_filtres input[name=adresse]').val()
  					}),
  			  contentType: 'application/json; charset=utf-8',
  			  url: '/home/filtres',
  			}).done (function (data) {
          $('.user_suggestion').remove();
          data.forEach(function(user){
            let div = document.createElement('div');
            div.setAttribute("class", "user_suggestion");
            //div.append("<p>" + user.nom + " - " + user.prenom + " - " + user.login +" <br> Age : " + user.age + "</p> <h3>" + user.sex + " - " + user.orientation + "</h3> <a href=users/"+user.login+">Go profil</a>");
          //  div.html  ("<h3>FLUTE</h3>")
          let test = `
          <div class="user_suggestion"><p> ${user.nom} -  ${user.prenom} - ${user.login} <br> Age : ${user.age} </p>
          <h3> ${user.sex} - ${user.orientation} </h3> <a href=users/${user.login}>Go profil</a></div>

          `;
            $('.suggestions').append(test);
            console.log(user);
          });
          console.log(data);
        });
  			// $(':input', '#form_filtres').not(':button, :submit, :reset, :hidden')
  			// .val('');
  			return false;
  		});

  $(function () {
    var socket = io.connect('http://localhost:3003');
	var user_name = <%- JSON.stringify(title) %>;

    //$('#setNick').submit(function(e){
     // e.preventDefault();
      socket.emit('new user', user_name, function(data){
         if (data) {
         //  $('#nickWrap').hide();
           $('#contentWrap').show();
         }
         else {
           $('#nickError').html('That username is already taken ! try again.');
         }
      });
     // $('#nickname').val('');
    //});

    socket.on('usernames', function(data){
      var html = '';
      for(i = 0;i < data.length; i++){
		  if (data[i] != user_name)
        	html += "<p class='friends'>" + data[i] + "</p><br/>";
      }
      $('#users').html(html);
	  $(".friends").click(function() {
		let desti = $(this)[0].innerText;
		if(document.getElementById(desti) == null)
		{
			let input = document.createElement('input');
			input.setAttribute("type", "text");

			let button = document.createElement('button');
			button.setAttribute("type", "submit");
			button.setAttribute("value", "send message");
			button.append("Send");

			let form = document.createElement('form');
			form.setAttribute("class", "form_mp");
			form.setAttribute("id", desti);
			form.appendChild(input);
			form.appendChild(button);

			let conv = document.createElement('div');

			let header = document.createElement('div');
			header.innerHTML += desti;

			let chat = document.createElement('div');
			chat.setAttribute("id", desti);
			chat.appendChild(header);
			chat.appendChild(conv);
			chat.appendChild(form);

			let allchat = document.getElementById("allchat");
			 //chat.style.backgroundColor = "white";
			 //chat.style.height = "300px";
			 //chat.style.width = "300px";
			allchat.style.border = "1px solid black";
			allchat.appendChild(chat);
			socket.emit('charge old messages', {desti: desti, autor: <%- JSON.stringify(title) %>}, function(){

			});
			socket.on('append old messages', async function(data){
          for(var el in data.elem[0].messages){
            $('#' + desti).append($('<li>').text(data.elem[0].messages[el].autor + ': ' + data.elem[0].messages[el].msg));
          }
		    });
			//}
			$('#' + desti).submit(function(){
				socket.emit('chat message', {desti: desti, msg: $(':input', '#' + desti).val()}, function(data){
					$('#messages').append("<span class='error'><li>" + data + "</li></span>");
				});
				$('#' + desti).append($('<li>').text(<%- JSON.stringify(title) %> + ': ' + $(':input', '#' + desti).val()))
				$(':input', '#' + desti).val('');
				return false;
			});
		}
  	});
    });

    // $('#mess').submit(function(){
    //   socket.emit('chat message', $('#m').val(), function(data){
	// 	  $('#messages').append("<span class='error'><li>" + data + "</li></span>");
	//   });
    //   //$('#messages').append($('<li>').text($('#m').val()))
    //   $('#m').val('');
    //   return false;
    // });




	/*socket.on('new message', function(data) {
		$('#messages').append("<span class='msg'><li>" + data.nick  + ": " + data.msg + "</li></span>");
	});*/

	socket.on('whisper', function(data) {
		// console.log(document.getElementById(data.nick));
		if(document.getElementById(data.nick) == null)
		{
			let desti = data.nick;

			let input = document.createElement('input');
			input.setAttribute("type", "text");

			let button = document.createElement('button');
			button.setAttribute("type", "submit");
			button.setAttribute("value", "send message");
			button.append("Send");

			let form = document.createElement('form');
			form.setAttribute("class", "form_mp");//
			form.setAttribute("id", data.nick);
			form.appendChild(input);
			form.appendChild(button);

			let conv = document.createElement('div');

			let header = document.createElement('div');
			header.innerHTML += desti;

			let chat = document.createElement('div');
			chat.setAttribute("id", desti);
			chat.appendChild(header);
			chat.appendChild(conv);
			chat.appendChild(form);

			let allchat = document.getElementById("allchat");
			 //chat.style.backgroundColor = "white";
			 //chat.style.height = "300px";
			 //chat.style.width = "300px";
			allchat.style.border = "1px solid black";
			allchat.appendChild(chat);
			$('#' + data.nick).submit(function(){
				socket.emit('chat message', {desti: desti, msg: $(':input', '#' + data.nick).val()}, function(data){
					$('#messages').append("<span class='error'><li>" + data + "</li></span>");
				});
				$('#' + data.nick).append($('<li>').text(<%- JSON.stringify(title) %> + ': ' + $(':input', '#' + data.nick).val()))
				$(':input', '#' + data.nick).val('');
				return false;
			});
		}
		$('#' + data.nick).append("<span class='whisper'><li>" + data.nick  + ": " + data.msg + "</li></span>");

	});




  });







});
  </script>

  </body>
</html>
